<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      max-width: 720px;
      padding: 32px 16px 0;
      text-align: center;
    }

    header h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #fff;
    }
    header p { font-size: 13px; color: #666; margin-top: 4px; }

    main {
      width: 100%;
      max-width: 720px;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1;
    }

    /* Search */
    .search-bar {
      display: flex;
      gap: 8px;
    }
    .search-bar input {
      flex: 1;
      padding: 10px 14px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
    }
    .search-bar input:focus { border-color: #3b82f6; }
    .search-bar button {
      padding: 10px 20px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }
    .search-bar button:hover { background: #2563eb; }
    .search-bar button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Now Playing */
    .now-playing {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .now-playing.hidden { display: none; }
    .np-info { flex: 1; min-width: 0; }
    .np-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .np-title { font-size: 15px; font-weight: 500; color: #fff; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .np-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .np-controls button {
      width: 36px; height: 36px;
      background: #252525; border: 1px solid #333; border-radius: 8px;
      color: #ccc; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, border-color 0.15s;
    }
    .np-controls button:hover { background: #333; border-color: #444; }

    .volume-group { display: flex; align-items: center; gap: 6px; margin-left: 8px; }
    .volume-group label { font-size: 12px; color: #666; }
    .volume-group input[type="range"] {
      width: 80px; accent-color: #3b82f6;
    }
    .volume-group span { font-size: 12px; color: #888; min-width: 28px; text-align: right; }

    /* Section headings */
    .section-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
      padding: 0 2px 6px;
    }

    /* Results / Favorites list */
    .results-list { display: flex; flex-direction: column; gap: 4px; }
    .result-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: #141414;
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.12s, border-color 0.12s;
    }
    .result-row:hover { background: #1c1c1c; border-color: #2a2a2a; }
    .result-row.active { border-color: #3b82f6; background: #1a1f2e; }

    .r-num { font-size: 12px; color: #555; min-width: 24px; text-align: right; }
    .r-name { flex: 1; font-size: 14px; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .r-meta { font-size: 12px; color: #555; flex-shrink: 0; }

    /* Fav star button */
    .r-fav {
      background: none; border: none; cursor: pointer;
      font-size: 16px; padding: 2px 4px; line-height: 1;
      transition: transform 0.15s;
      flex-shrink: 0;
    }
    .r-fav:hover { transform: scale(1.25); }
    .r-fav.is-fav { color: #f59e0b; }
    .r-fav:not(.is-fav) { color: #444; }

    .empty-state { text-align: center; padding: 48px 0; color: #444; font-size: 14px; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #444; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<header>
  <h1>Radio</h1>
  <p>Search &amp; stream internet radio stations</p>
</header>

<main>
  <div class="search-bar">
    <input id="q" type="text" placeholder="Search stations..." autocomplete="off" />
    <button id="searchBtn">Search</button>
  </div>

  <div class="now-playing hidden" id="np">
    <div class="np-info">
      <div class="np-label">Now Playing</div>
      <div class="np-title" id="npTitle">--</div>
    </div>
    <div class="np-controls">
      <button id="pauseBtn" title="Pause">&#x23F8;</button>
      <button id="stopBtn" title="Stop">&#x23F9;</button>
      <div class="volume-group">
        <label>Vol</label>
        <input type="range" id="volSlider" min="0" max="100" value="100" />
        <span id="volVal">100</span>
      </div>
    </div>
  </div>

  <div id="favSection"></div>
  <div id="results"></div>
</main>

<script>
  const $ = (s) => document.querySelector(s);
  const qInput = $("#q");
  const searchBtn = $("#searchBtn");
  const favSection = $("#favSection");
  const resultsDiv = $("#results");
  const np = $("#np");
  const npTitle = $("#npTitle");
  const pauseBtn = $("#pauseBtn");
  const stopBtn = $("#stopBtn");
  const volSlider = $("#volSlider");
  const volVal = $("#volVal");

  let stations = [];      // search results
  let favorites = [];     // favorite stations
  let favUuids = new Set();
  let activeUuid = null;  // currently playing station uuid

  // --- Favorites ---
  async function loadFavs() {
    try {
      const res = await fetch("/api/favs");
      favorites = await res.json();
      favUuids = new Set(favorites.map(f => f.stationuuid));
      renderFavs();
    } catch { /* ignore */ }
  }

  async function toggleFav(station) {
    if (favUuids.has(station.stationuuid)) {
      // Remove
      await fetch("/api/favs/remove", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uuid: station.stationuuid }),
      });
    } else {
      // Add
      await fetch("/api/favs/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(station),
      });
    }
    await loadFavs();
    renderSearchResults();
  }

  function renderFavs() {
    if (!favorites.length) {
      favSection.innerHTML = "";
      return;
    }
    favSection.innerHTML =
      '<div class="section-label">Favorites</div>' +
      '<div class="results-list">' +
      favorites.map((s, i) => {
        const br = s.bitrate ? s.bitrate + "k" : "";
        const meta = [s.country, s.codec, br].filter(Boolean).join(" / ");
        const isActive = s.stationuuid === activeUuid;
        const cls = isActive ? "result-row active" : "result-row";
        return `<div class="${cls}" data-fav-idx="${i}" data-uuid="${s.stationuuid}">
          <span class="r-num">${i + 1}</span>
          <span class="r-name">${esc(s.name)}</span>
          <span class="r-meta">${esc(meta)}</span>
          <button class="r-fav is-fav" data-fav-uuid="${s.stationuuid}" title="Remove from favorites">&#9733;</button>
        </div>`;
      }).join("") +
      '</div>';

    // Play on row click
    favSection.querySelectorAll(".result-row").forEach(row => {
      row.addEventListener("click", (e) => {
        if (e.target.closest(".r-fav")) return;
        playStation(favorites[Number(row.dataset.favIdx)]);
      });
    });

    // Remove on star click
    favSection.querySelectorAll(".r-fav").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const uuid = btn.dataset.favUuid;
        const st = favorites.find(f => f.stationuuid === uuid);
        if (st) toggleFav(st);
      });
    });
  }

  // --- Search ---
  async function doSearch() {
    const q = qInput.value.trim();
    if (!q) return;
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<span class="spinner"></span>';
    try {
      const res = await fetch(`/api/search?q=${encodeURIComponent(q)}&limit=30`);
      stations = await res.json();
      renderSearchResults();
    } catch (e) {
      resultsDiv.innerHTML = '<div class="empty-state">Search failed</div>';
    } finally {
      searchBtn.disabled = false;
      searchBtn.textContent = "Search";
    }
  }

  searchBtn.addEventListener("click", doSearch);
  qInput.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(); });

  // --- Render search results ---
  function renderSearchResults() {
    if (!stations.length) {
      if (favorites.length) {
        resultsDiv.innerHTML = "";
      } else {
        resultsDiv.innerHTML = '<div class="empty-state">Search for stations above</div>';
      }
      return;
    }
    resultsDiv.innerHTML =
      '<div class="section-label">Search Results</div>' +
      '<div class="results-list">' +
      stations.map((s, i) => {
        const br = s.bitrate ? s.bitrate + "k" : "";
        const meta = [s.country, s.codec, br].filter(Boolean).join(" / ");
        const isActive = s.stationuuid === activeUuid;
        const isFav = favUuids.has(s.stationuuid);
        const cls = isActive ? "result-row active" : "result-row";
        const starCls = isFav ? "r-fav is-fav" : "r-fav";
        const star = isFav ? "&#9733;" : "&#9734;";
        return `<div class="${cls}" data-idx="${i}">
          <span class="r-num">${i + 1}</span>
          <span class="r-name">${esc(s.name)}</span>
          <span class="r-meta">${esc(meta)}</span>
          <button class="${starCls}" data-search-idx="${i}" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}">${star}</button>
        </div>`;
      }).join("") +
      '</div>';

    // Play on row click
    resultsDiv.querySelectorAll(".result-row").forEach(row => {
      row.addEventListener("click", (e) => {
        if (e.target.closest(".r-fav")) return;
        playIdx(Number(row.dataset.idx));
      });
    });

    // Toggle fav on star click
    resultsDiv.querySelectorAll(".r-fav").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const st = stations[Number(btn.dataset.searchIdx)];
        if (st) toggleFav(st);
      });
    });
  }

  function esc(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // --- Play ---
  async function playIdx(idx) {
    try {
      const res = await fetch(`/api/play?i=${idx}`);
      const data = await res.json();
      if (data.ok) {
        showNowPlaying(data.station);
      }
    } catch { /* ignore */ }
  }

  async function playStation(station) {
    try {
      const res = await fetch("/api/play", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uuid: station.stationuuid, url: station.url_resolved, name: station.name }),
      });
      const data = await res.json();
      if (data.ok) {
        showNowPlaying(station);
      }
    } catch { /* ignore */ }
  }

  function showNowPlaying(station) {
    activeUuid = station.stationuuid;
    npTitle.textContent = station.name;
    np.classList.remove("hidden");
    pauseBtn.innerHTML = "&#x23F8;";
    renderFavs();
    renderSearchResults();
  }

  // --- Controls ---
  pauseBtn.addEventListener("click", async () => {
    await fetch("/api/pause");
    pauseBtn.innerHTML = pauseBtn.textContent.charCodeAt(0) === 9208 ? "&#x25B6;" : "&#x23F8;";
  });

  stopBtn.addEventListener("click", async () => {
    await fetch("/api/stop");
    np.classList.add("hidden");
    activeUuid = null;
    renderFavs();
    renderSearchResults();
  });

  volSlider.addEventListener("input", async () => {
    const v = volSlider.value;
    volVal.textContent = v;
    await fetch(`/api/vol?v=${v}`);
  });

  // --- Init: load status + favorites ---
  (async () => {
    await loadFavs();
    try {
      const res = await fetch("/api/status");
      const s = await res.json();
      if (s.uuid) {
        activeUuid = s.uuid;
        npTitle.textContent = s.title || s.uuid;
        np.classList.remove("hidden");
        volSlider.value = s.volume;
        volVal.textContent = s.volume;
        pauseBtn.innerHTML = s.paused ? "&#x25B6;" : "&#x23F8;";
        renderFavs();
      }
    } catch { /* server may not be ready */ }
  })();
</script>
</body>
</html>
